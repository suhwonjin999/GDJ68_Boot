<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- base 패키지명.클래스명 -->
  <mapper namespace="com.winter.app.board.notice.NoticeDAO">
  <!-- 동일한 쿼리를 조각으로 나누는 태그 : sql 태그 -->
  	<sql id="forPager">
  	<!-- kind 값이 1이 넘어오면 title에서 검색하겠다. -->
<!--  <if test="kind=='1'">
  			boardTitle
  		</if>
  		
  		<if test="kind=='2'">
  			boardWriter
  		</if>
  		
  		<if test="kind=='3'">
  			boardContents
  		</if> -->
	  	<choose>
  			<when test="kind=='1'">
  				boardTitle
  			</when>
  <!-- 홑따옴표 사용하는 이유 : 변수로서 가져오는게 아니라 값으로 가져온다는 의미이다.  -->
  <!-- 홑따옴표를 사용하지 않으면 변수로 가져온다는 것으로 인식함. -->
  			<when test="kind=='2'">
  				boardContents
  			</when>
  			<otherwise>
  				boardWriter
  			</otherwise>
  		</choose>
  	</sql>
  	
  <select id="getCount" parameterType="Pager" resultType="Long">
  	<!-- bind 동적 태그 : Mybatis에서 제공하는 동적 쿼리를 이용하는 방식 -->
  	<!-- 언더바 _ : 내부 파라미터를 표시하는 예약어 (Pager 파라미터로 접근하는 예약어이다.) -->
  	<!-- _parameter는 파라미터 타입으로 받아온 객체인 Pager를 의미함. Pager에서 search라는 값을 꺼내옴. -->
  	<bind name="pattern" value="'%'+_parameter.getSearch()+'%'"></bind>
  	SELECT COUNT(BOARDNO) FROM NOTICE
  	WHERE <include refid="forPager"></include>
  	LIKE #{pattern}
  </select>	
  	
  <!-- Pager에서 값을 가져올 때 getter명으로 가져온다. -->
  <select id="getList" parameterType="Pager" resultType="NoticeVO">
  	<!-- SELECT * FROM NOTICE ORDER BY BOARDNO DESC -->
  	<!-- 타이틀, 제목, 작성자에서 검색할 지 다르기때문에 파라미터로 넣어서 넘겨준다. -->
  	<!-- 시작인덱스번호, 개수, 어떤것을 검색할 것인가(어떤 컬럼에서 검색어를 무엇을 쓸 것인가), 어디에서 검색할 것인가 변수 4개 필요. -->
  	<!-- 클래스를 만들어서 객체를 만들거나 혹은 list, map을 이용해서 넣어준다. -->
  	<!-- 4개 변수를 Pager 클래스에 담았다.  -->
  	<!-- LIKE '%%' : 전부다 가져와라. -->
  	SELECT * FROM NOTICE
<!-- 	WHERE BOARDTITLE LIKE '%%' -->
<!-- '%#{search}%' : '#{search}' 문자열로 인식되기 때문에 이렇게 쓸수 없다. 그래서 문자열합쳐서(CONCAT) 사용해야 함. -->
	WHERE
		<include refid="forPager"></include>
		LIKE CONCAT('%',#{search},'%')
	ORDER BY BOARDNO DESC 
	LIMIT #{startRow}, #{lastRow};
	<!-- startRow, lastRow 변수에 NULL이 왔을 때 에러 발생함. --> 
  </select>
  
  <!-- 데이터 등록(INSERT) -->
  <!-- 1씩 증가되는 기능 : useGenerateKeys -->
  <!-- 쿼리 실행 순서: INSERT 쿼리가 먼저 실행되어 등록한 후 발생된 키를 이용하여 1씩 증가하게 만듦.  -->
  <insert id="add" parameterType="BoardVO" useGeneratedKeys="true" keyProperty="boardNo">
<!-- Oracle 방식 -->
<!--  <selectKey keyProperty="boardNo" order="BEFORE" resultType="Long"> -->
<!--   	SELECT SEQ.NEXTVAL FROM DUAL -->
<!--  </selectKey> -->
  <!-- 데이터가 추가되면 자동으로 1씩 따라 증가되는 기능 : 0 혹은 NULL을 집어넣어야 자동으로 시퀀스 기능을 한다. -->
  <!-- 수정은 boardTitle, boardContents만 가능하다.  -->
<!-- HIT(조회수)가 {boardNo} 라면 NULL값이 먼저 들어온다. -->
  	INSERT INTO NOTICE
  	VALUES (NULL, #{boardTitle}, #{boardWriter}, #{boardContents}, NOW(), 0)
  </insert>
  
  <insert id="fileAdd" parameterType="NoticeFileVO">
  	INSERT INTO NOTICEFILES
  	VALUES(#{fileNO}, #{boardNo}, #{fileName}, #{oriName})
  </insert>
  
  
  <!-- Detail -->
  <!-- 글 하나만 꺼내오는게 아니라 첨부한 파일과 같이 불러오기위해 조인해줘야 한다.(ANSI JOIN 방식) -->
  <!-- INNER 조인 : 무조건 테이블에 값이 들어있는 경우 사용함. -->
  <!-- 데이터가 있는 방향을 지정함. OUTER JOIN -->
  <!-- JOIN 조건 : ON, USING  -->
  <!-- USING : 두 테이블 간 컬럼의 이름이 동일한 경우 사용함. 대신 SELECT 절에서 * 사용하지 못함. -->
  	<select id="getDetail" parameterType="BoardVO" resultMap="getDetailResult">
  		SELECT N.*, NF.*
  		FROM NOTICE N 
  			 LEFT OUTER JOIN
  			 NOTICEFILES NF 
  			 ON N.BOARDNO = NF.BOARDNO
  		WHERE N.BOARDNO=#{boardNo}
  	</select>
  <!-- 글 하나에 파일 여러개 : 1대N 관계(DB에서 표현) : (자바식 표현)NOTICE 하나가 파일 여러개를 가지고 있다.(포함하고 있다) -->
  <!-- 최종적으로 리턴 : NoticeVO -->	
  	<resultMap type="NoticeVO" id="getDetailResult">
  		<id column="BOARDNO" property="boardNo"/>
  		<result column="BOARDTITLE" property="boardTitle"/>
  		<result column="BOARDWRITER" property="boardWriter"/>
  		<result column="BOARDCONTENTS" property="boardContents"/>
  		<result column="BOARDDATE" property="boardDate"/>
  		<result column="BOARDHIT" property="boardHit"/>
  		<collection property="list" javaType="java.util.List" ofType="NoticeFileVO">
  			<id column="FILENO" property="fileNo"/>
  			<result column="FILENAME" property="fileName"/>
  			<result column="ORINAME" property="oriName"/>
  		</collection>
  	</resultMap>
  	
  
  <!-- 데이터 변경 시 Update -->
 	<update id="setUpdate" parameterType="BoardVO">
  		UPDATE NOTICE SET 
  			BOARDTITLE=#{boardTitle},
  			BOARDCONTENTS=#{boardContets}
  		WHERE BOARDNO=#{boardNo}
  	</update>
  	
  
  <!-- 조회수 Update -->
  	<update id="setHitUpdate" parameterType="BoardVO">
  		UPDATE NOTICE SET BOARDHIT=BOARDHIT+1 WHERE BOARDNO=#{boardNo}
  	</update>
  
  
  <!-- 데이터 삭제 시 Delete -->
  	<delete id="setDelete" parameterType="BoardVO">
  		DELETE FROM NOTICE WHERE BOARDNO=#{boardNo}
  	</delete>
  	
  	<select id="getFileDetail" parameterType="FileVO" resultType="NoticeFileVO">
  		SELECT * FROM NOTICEFILES 
  		WHERE FILENO = #{fileNo}
  	</select>
  
  
  </mapper>